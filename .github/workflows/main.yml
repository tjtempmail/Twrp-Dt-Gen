name: Make TWRP Device

on:
  workflow_dispatch:
    inputs:
      IMG_URL:
        description: 'URL of boot/recovery image (optional if file uploaded)'
        required: false
        default: ''
      IMG_FILE:
        description: 'Upload boot/recovery image file directly (optional if URL provided)'
        required: false
        type: file

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-22.04

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip cpio wget aria2
        pip3 install twrpdtgen

    - name: Determine image source and prepare image
      id: source
      run: |
        # Check if file was uploaded
        if [ -n "${{ inputs.IMG_FILE }}" ]; then
          echo "Using uploaded file"
          echo "${{ inputs.IMG_FILE }}" | base64 -d > image.img
        elif [ -n "${{ inputs.IMG_URL }}" ]; then
          echo "Using URL"
          aria2c -o image.img "${{ inputs.IMG_URL }}"
        else
          echo "Error: Neither IMG_URL nor IMG_FILE provided."
          exit 1
        fi

    - name: Generate device tree
      run: |
        mkdir dt
        python3 -m twrpdtgen -o dt/ image.img

    - name: Zip device tree
      run: |
        zip -r DeviceTree.zip dt/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: DeviceTree.zip
        name: TWRP Device Tree ${{ github.run_id }}
        tag_name: ${{ github.run_id }}
        body: Automatically generated device tree for TWRP.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
